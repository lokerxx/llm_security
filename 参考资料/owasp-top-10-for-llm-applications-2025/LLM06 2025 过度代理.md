# LLM06:2025 过度代理

## 描述

基于LLM的系统通常由开发者赋予一定的代理能力，即通过扩展（被不同供应商称为工具、技能或插件）调用函数或与其他系统交互，以响应提示进行操作。决定调用哪个扩展的功能可能会委派给LLM“代理”，由其根据输入提示或LLM输出动态确定。  
代理系统通常会多次调用LLM，使用先前调用的输出来确定和指导后续调用。

**过度代理（Excessive Agency）** 是一种漏洞，当LLM出现故障时，可能导致执行有害操作。这些故障可能由以下原因触发：
- 由设计不良的提示引发的幻觉或虚构输出，或模型性能不足；
- 来自恶意用户的直接/间接提示注入；
- 来自恶意或受损的扩展（包括多代理/协作系统中的同伴代理）的攻击。

### **根本原因：**
过度代理的核心通常包括以下一个或多个因素：
- **功能过多**  
  提供了不必要的功能。
- **权限过高**  
  赋予的权限超出了应用程序操作的需求。
- **自主性过强**  
  系统缺乏对高影响力操作的验证或批准。

### **影响范围：**
过度代理可能对机密性、完整性和可用性产生广泛影响，具体取决于LLM应用程序可以与哪些系统交互。

> **注意**：过度代理不同于输出处理不当，后者专注于LLM输出的审查不足问题。

---

## 常见风险示例

1. **功能过多**  
   LLM代理可以访问不必要的扩展功能。例如，开发者需要为LLM代理提供从存储库读取文档的功能，但所选的第三方扩展还包括修改和删除文档的功能。

2. **功能过多**  
   在开发阶段试用的扩展被替换为更好的替代品，但原始插件仍对LLM代理可用。

3. **功能过多**  
   一个具有开放式功能的LLM插件未能正确过滤输入指令，从而允许执行超出应用程序必要操作范围的命令。例如，一个用于运行特定Shell命令的扩展未能阻止执行其他Shell命令。

4. **权限过高**  
   一个LLM扩展在下游系统上拥有超出应用程序需求的权限。例如，一个仅用于读取数据的扩展，通过具有SELECT、UPDATE、INSERT和DELETE权限的身份连接到数据库服务器。

5. **权限过高**  
   一个设计为以个人用户上下文执行操作的LLM扩展，通过高权限的通用身份访问下游系统。例如，一个用于读取当前用户文档存储的扩展，通过一个特权账户连接到文档存储库，该账户可以访问所有用户的文件。

6. **自主性过强**  
   一个基于LLM的应用程序或扩展未能对高影响力操作进行独立验证和批准。例如，一个允许删除用户文档的扩展在没有用户确认的情况下执行删除操作。

---

## 预防和缓解策略

1. **功能限制**  
   确保LLM代理和扩展仅具备实现必要功能的权限，不允许执行额外或潜在危险的操作。

2. **权限最小化**  
   遵循“最小权限原则”，限制LLM扩展在下游系统上的权限，只授予必要权限以完成指定任务。

3. **用户确认**  
   对高风险操作实施用户确认机制，确保任何潜在有害的操作都需获得明确授权。

4. **日志和监控**  
   实施强大的日志记录和监控系统，及时发现和应对过度代理的利用尝试。

5. **独立验证**  
   为高影响力的任务设计独立的验证流程，确保操作的安全性和必要性。

6. **定期审查扩展**  
   定期审查和更新可用的扩展，删除多余或不安全的扩展。

7. **安全开发实践**  
   在开发阶段对代理系统的功能和权限进行全面审查，确保不存在不必要的功能泄漏。

---

## 示例攻击场景

### 场景 #1: **功能过多**  
一个LLM代理被赋予访问扩展的权限，这些扩展不仅允许读取文档，还能修改和删除文档，从而引发未授权的操作。

### 场景 #2: **滥用未移除的开发插件**  
开发阶段试用的插件未被移除，攻击者利用这个插件执行不必要的操作。

### 场景 #3: **命令过滤不当**  
一个插件允许执行Shell命令，但未正确限制其范围，导致可以运行其他高危命令。

### 场景 #4: **高权限身份滥用**  
一个读取用户数据的扩展，通过一个通用的高权限账户连接到文档存储库，导致所有用户的文件被泄露。

### 场景 #5: **缺乏用户确认**  
一个文档删除功能的扩展在未获得用户确认的情况下执行删除操作，导致数据丢失。



## 预防和缓解策略

以下措施可以预防过度代理的风险：

### 1. **最小化扩展数量**  
   限制LLM代理可调用的扩展数量，仅允许调用必要的扩展。例如，如果基于LLM的系统不需要获取URL内容的能力，则不应向LLM代理提供此类扩展。

### 2. **最小化扩展功能**  
   限制LLM扩展中实现的功能数量，仅保留必要的功能。例如，用于访问用户邮箱的扩展如果仅需读取邮件的能力，则该扩展不应包含删除或发送邮件的功能。

### 3. **避免使用开放式扩展**  
   避免使用功能开放的扩展（如运行Shell命令、获取URL等），优先选择功能粒度更细的扩展。例如，如果LLM应用程序需要将输出写入文件，安全的替代方案是开发一个特定的文件写入扩展，而不是使用运行Shell命令的扩展。

### 4. **最小化扩展权限**  
   限制LLM扩展对其他系统的权限，仅授予必要权限以减少潜在的有害操作。例如，一个用于推荐产品的LLM代理只需要读取“产品”表的权限，而不应有对其他表的访问权限，也不应具有插入、更新或删除记录的权限。

### 5. **在用户上下文中执行扩展**  
   跟踪用户授权和安全范围，确保在用户的上下文中执行所有操作，并使用最低权限。例如，读取用户代码库的LLM扩展应要求用户通过OAuth认证，并使用最小授权范围。

### 6. **要求用户批准**  
   使用人机协作控制，要求在人为批准后才能执行高影响力操作。这可以在下游系统中实现，也可以在LLM扩展中实现。例如，一个代表用户发布社交媒体内容的LLM应用程序，应在扩展中加入“发布”操作的用户审批机制。

### 7. **完整中介原则**  
   在下游系统中实施授权，而不是依赖LLM决定操作是否被允许。遵循完整中介原则，确保所有通过扩展向下游系统发出的请求都经过安全策略验证。

### 8. **清理LLM输入和输出**  
   遵循安全编码的最佳实践，例如应用OWASP ASVS（应用程序安全验证标准）的建议，特别关注输入清理。使用静态应用程序安全测试（SAST）和动态交互式应用程序测试（DAST、IAST）工具集成到开发管道中。

---

## 限制潜在损害的措施

尽管以下措施不能完全防止过度代理，但可以减少其可能造成的损害：

- **日志和监控**  
  记录并监控LLM扩展和下游系统的活动，识别不良操作并及时响应。  
- **速率限制**  
  限制一定时间内的操作次数，降低大量不良操作发生的可能性，同时增加监控系统发现异常的时间窗口。

---

## 示例攻击场景

一个基于LLM的个人助理应用通过扩展访问用户邮箱，以总结收到的电子邮件内容。实现此功能需要读取邮件的权限，但系统开发者选择的插件还包含发送邮件的功能。此外，该应用易受间接提示注入攻击，一封恶意构造的来信可能会诱使LLM命令代理扫描用户的收件箱以查找敏感信息，并将其转发到攻击者的电子邮件地址。

### **避免此攻击的措施**
1. **消除过多功能**  
   使用仅实现邮件读取功能的扩展。  
2. **消除过多权限**  
   通过OAuth会话以只读范围认证到用户的邮件服务。  
3. **消除过强自主性**  
   要求用户手动审查并点击“发送”按钮以确认所有由LLM扩展起草的邮件。

### **减少损害的措施**
通过在邮件发送接口上实施速率限制，降低恶意行为造成的大规模损害可能性。